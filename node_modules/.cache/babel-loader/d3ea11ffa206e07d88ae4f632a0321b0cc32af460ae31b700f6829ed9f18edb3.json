{"ast":null,"code":"import { get, isArray, isNumber, map } from '@antv/util';\nimport { geometry as baseGeometry } from '../../../adaptor/geometries/base';\nimport { deepAssign, flow } from '../../../utils';\nimport { getTooltipMapping } from '../../../utils/tooltip';\nimport { FUNNEL_CONVERSATION, FUNNEL_MAPPING_VALUE, FUNNEL_PERCENT } from '../constant';\nimport { conversionTagComponent, transformData } from './common';\n/**\n * 处理字段数据\n * @param params\n */\nfunction field(params) {\n  var _a;\n  var chart = params.chart,\n    options = params.options;\n  var _b = options.data,\n    data = _b === void 0 ? [] : _b,\n    yField = options.yField;\n  // 绘制漏斗图\n  chart.data(data);\n  chart.scale((_a = {}, _a[yField] = {\n    sync: true\n  }, _a));\n  return params;\n}\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params) {\n  var chart = params.chart,\n    options = params.options;\n  var data = options.data,\n    xField = options.xField,\n    yField = options.yField,\n    color = options.color,\n    compareField = options.compareField,\n    isTransposed = options.isTransposed,\n    tooltip = options.tooltip,\n    maxSize = options.maxSize,\n    minSize = options.minSize,\n    label = options.label,\n    funnelStyle = options.funnelStyle,\n    state = options.state,\n    showFacetTitle = options.showFacetTitle;\n  chart.facet('mirror', {\n    fields: [compareField],\n    // 漏斗图的转置规则与分面相反，默认是垂直布局\n    transpose: !isTransposed,\n    padding: isTransposed ? 0 : [32, 0, 0, 0],\n    showTitle: showFacetTitle,\n    eachView: function eachView(view, facet) {\n      var index = isTransposed ? facet.rowIndex : facet.columnIndex;\n      if (!isTransposed) {\n        view.coordinate({\n          type: 'rect',\n          actions: [['transpose'], ['scale', index === 0 ? -1 : 1, -1]]\n        });\n      }\n      var formatterData = transformData(facet.data, data, {\n        yField: yField,\n        maxSize: maxSize,\n        minSize: minSize\n      });\n      view.data(formatterData);\n      // 绘制图形\n      var _a = getTooltipMapping(tooltip, [xField, yField, compareField]),\n        fields = _a.fields,\n        formatter = _a.formatter;\n      var defaultFacetLabel = isTransposed ? {\n        offset: index === 0 ? 10 : -23,\n        position: index === 0 ? 'bottom' : 'top'\n      } : {\n        offset: 10,\n        position: 'left',\n        style: {\n          textAlign: index === 0 ? 'end' : 'start'\n        }\n      };\n      baseGeometry({\n        chart: view,\n        options: {\n          type: 'interval',\n          xField: xField,\n          yField: FUNNEL_MAPPING_VALUE,\n          colorField: xField,\n          tooltipFields: isArray(fields) && fields.concat([FUNNEL_PERCENT, FUNNEL_CONVERSATION]),\n          mapping: {\n            // todo 暂时不提供 金字塔 shape，后续需要自定义下形状\n            shape: 'funnel',\n            tooltip: formatter,\n            color: color,\n            style: funnelStyle\n          },\n          label: label === false ? false : deepAssign({}, defaultFacetLabel, label),\n          state: state\n        }\n      });\n    }\n  });\n  return params;\n}\nexport function compareConversionTag(params) {\n  // @ts-ignore\n  var chart = params.chart,\n    index = params.index,\n    options = params.options;\n  var conversionTag = options.conversionTag,\n    isTransposed = options.isTransposed;\n  (isNumber(index) ? [chart] : chart.views).forEach(function (view, viewIndex) {\n    // 获取形状位置，再转化为需要的转化率位置\n    var dataArray = get(view, ['geometries', '0', 'dataArray'], []);\n    var size = get(view, ['options', 'data', 'length']);\n    var x = map(dataArray, function (item) {\n      return get(item, ['0', 'nextPoints', '0', 'x']) * size - 0.5;\n    });\n    var getLineCoordinate = function getLineCoordinate(datum, datumIndex, data, initLineOption) {\n      var ratio = (index || viewIndex) === 0 ? -1 : 1;\n      return deepAssign({}, initLineOption, {\n        start: [x[datumIndex - 1] || datumIndex - 0.5, datum[FUNNEL_MAPPING_VALUE]],\n        end: [x[datumIndex - 1] || datumIndex - 0.5, datum[FUNNEL_MAPPING_VALUE] + 0.05],\n        text: isTransposed ? {\n          style: {\n            textAlign: 'start'\n          }\n        } : {\n          offsetX: conversionTag !== false ? ratio * conversionTag.offsetX : 0,\n          style: {\n            textAlign: (index || viewIndex) === 0 ? 'end' : 'start'\n          }\n        }\n      });\n    };\n    conversionTagComponent(getLineCoordinate)(deepAssign({}, {\n      chart: view,\n      options: options\n    }));\n  });\n}\n/**\n * 转化率组件\n * @param params\n */\nfunction conversionTag(params) {\n  var chart = params.chart;\n  // @ts-ignore\n  chart.once('beforepaint', function () {\n    return compareConversionTag(params);\n  });\n  return params;\n}\n/**\n * 对比漏斗\n * @param chart\n * @param options\n */\nexport function compareFunnel(params) {\n  return flow(field, geometry, conversionTag)(params);\n}","map":{"version":3,"mappings":"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","names":["get","isArray","isNumber","map","geometry","baseGeometry","deepAssign","flow","getTooltipMapping","FUNNEL_CONVERSATION","FUNNEL_MAPPING_VALUE","FUNNEL_PERCENT","conversionTagComponent","transformData","field","params","options","data","yField","chart","scale","_a","sync","xField","color","compareField","isTransposed","tooltip","maxSize","minSize","label","funnelStyle","state","showFacetTitle","facet","fields","transpose","padding","showTitle","eachView","view","index","rowIndex","columnIndex","coordinate","type","actions","formatterData","formatter","defaultFacetLabel","offset","position","style","textAlign","colorField","tooltipFields","concat","mapping","shape","compareConversionTag","views","forEach","viewIndex","dataArray","size","x","item","getLineCoordinate","datum","datumIndex","initLineOption","ratio","start","end","text","offsetX","conversionTag","once","compareFunnel"],"sources":["/home/iam/Documents/network/node_modules/@antv/g2plot/src/plots/funnel/geometries/compare.ts"],"sourcesContent":["import { Types } from '@antv/g2';\nimport { get, isArray, isNumber, map } from '@antv/util';\nimport { geometry as baseGeometry } from '../../../adaptor/geometries/base';\nimport { Params } from '../../../core/adaptor';\nimport { Data, Datum } from '../../../types/common';\nimport { deepAssign, flow } from '../../../utils';\nimport { getTooltipMapping } from '../../../utils/tooltip';\nimport { FUNNEL_CONVERSATION, FUNNEL_MAPPING_VALUE, FUNNEL_PERCENT } from '../constant';\nimport { FunnelOptions } from '../types';\nimport { conversionTagComponent, transformData } from './common';\n\n/**\n * 处理字段数据\n * @param params\n */\nfunction field(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const { data = [], yField } = options;\n\n  // 绘制漏斗图\n  chart.data(data);\n  chart.scale({\n    [yField]: {\n      sync: true,\n    },\n  });\n  return params;\n}\n\n/**\n * geometry处理\n * @param params\n */\nfunction geometry(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart, options } = params;\n  const {\n    data,\n    xField,\n    yField,\n    color,\n    compareField,\n    isTransposed,\n    tooltip,\n    maxSize,\n    minSize,\n    label,\n    funnelStyle,\n    state,\n    showFacetTitle,\n  } = options;\n\n  chart.facet('mirror', {\n    fields: [compareField],\n    // 漏斗图的转置规则与分面相反，默认是垂直布局\n    transpose: !isTransposed,\n    padding: isTransposed ? 0 : [32, 0, 0, 0],\n    showTitle: showFacetTitle,\n    eachView(view, facet) {\n      const index = isTransposed ? facet.rowIndex : facet.columnIndex;\n\n      if (!isTransposed) {\n        view.coordinate({\n          type: 'rect',\n          actions: [['transpose'], ['scale', index === 0 ? -1 : 1, -1]],\n        });\n      }\n\n      const formatterData = transformData(facet.data, data, {\n        yField,\n        maxSize,\n        minSize,\n      });\n\n      view.data(formatterData);\n\n      // 绘制图形\n      const { fields, formatter } = getTooltipMapping(tooltip, [xField, yField, compareField]);\n\n      const defaultFacetLabel = isTransposed\n        ? {\n            offset: index === 0 ? 10 : -23,\n            position: (index === 0 ? 'bottom' : 'top') as Types.IntervalGeometryLabelPosition,\n          }\n        : {\n            offset: 10,\n            position: 'left' as Types.IntervalGeometryLabelPosition,\n            style: {\n              textAlign: index === 0 ? 'end' : 'start',\n            },\n          };\n\n      baseGeometry({\n        chart: view,\n        options: {\n          type: 'interval',\n          xField: xField,\n          yField: FUNNEL_MAPPING_VALUE,\n          colorField: xField,\n          tooltipFields: isArray(fields) && fields.concat([FUNNEL_PERCENT, FUNNEL_CONVERSATION]),\n          mapping: {\n            // todo 暂时不提供 金字塔 shape，后续需要自定义下形状\n            shape: 'funnel',\n            tooltip: formatter,\n            color,\n            style: funnelStyle,\n          },\n          label: label === false ? false : deepAssign({}, defaultFacetLabel, label),\n          state,\n        },\n      });\n    },\n  });\n\n  return params;\n}\n\nexport function compareConversionTag(params: Params<FunnelOptions>) {\n  // @ts-ignore\n  const { chart, index, options } = params;\n  const { conversionTag, isTransposed } = options;\n  (isNumber(index) ? [chart] : chart.views).forEach((view, viewIndex) => {\n    // 获取形状位置，再转化为需要的转化率位置\n    const dataArray = get(view, ['geometries', '0', 'dataArray'], []);\n    const size = get(view, ['options', 'data', 'length']);\n    const x = map(dataArray, (item) => get(item, ['0', 'nextPoints', '0', 'x']) * size - 0.5);\n\n    const getLineCoordinate = (\n      datum: Datum,\n      datumIndex: number,\n      data: Data,\n      initLineOption: Record<string, any>\n    ): Types.LineOption => {\n      const ratio = (index || viewIndex) === 0 ? -1 : 1;\n      return deepAssign({}, initLineOption, {\n        start: [x[datumIndex - 1] || datumIndex - 0.5, datum[FUNNEL_MAPPING_VALUE]],\n        end: [x[datumIndex - 1] || datumIndex - 0.5, datum[FUNNEL_MAPPING_VALUE] + 0.05],\n        text: isTransposed\n          ? {\n              style: {\n                textAlign: 'start',\n              },\n            }\n          : {\n              offsetX: conversionTag !== false ? ratio * conversionTag.offsetX : 0,\n              style: {\n                textAlign: (index || viewIndex) === 0 ? 'end' : 'start',\n              },\n            },\n      });\n    };\n\n    conversionTagComponent(getLineCoordinate)(\n      deepAssign(\n        {},\n        {\n          chart: view,\n          options,\n        }\n      )\n    );\n  });\n}\n\n/**\n * 转化率组件\n * @param params\n */\nfunction conversionTag(params: Params<FunnelOptions>): Params<FunnelOptions> {\n  const { chart } = params;\n  // @ts-ignore\n  chart.once('beforepaint', () => compareConversionTag(params));\n  return params;\n}\n\n/**\n * 对比漏斗\n * @param chart\n * @param options\n */\nexport function compareFunnel(params: Params<FunnelOptions>) {\n  return flow(field, geometry, conversionTag)(params);\n}\n"]},"metadata":{},"sourceType":"module","externalDependencies":[]}